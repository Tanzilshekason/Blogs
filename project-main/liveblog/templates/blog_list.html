{% extends "base.html" %}

{% block content %}
<div class="container mt-4" id="post-container">

    {% for post in page_obj %}
        {% include 'post_card.html' with post=post user=request.user %}
    {% empty %}
        <div class="alert alert-info">No blog posts found.</div>
    {% endfor %}

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
            {% endif %}
        </ul>
    </nav>

    <div class="text-center mt-4" id="post-container">
        {% if user.is_authenticated %}
            <a href="{% url 'blog_create' %}" class="btn btn-success me-2">Create New Post</a>
            <a href="{% url 'logout' %}" class="btn btn-outline-secondary">Logout</a>
        {% else %}
            <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- JavaScript for WebSocket -->
 {% block scripts %}
<script>
    const currentUsername = "{{ request.user.username }}";

    const socket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/blog/"
    );

    socket.onopen = function () {
        console.log("WebSocket connected.");
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const postContainer = document.getElementById("post-container");

        // Handle deletion
        if (data.delete_id) {
            const postElement = document.getElementById(`post-${data.delete_id}`);
            if (postElement) {
                postElement.remove();
                console.log(`Post ${data.delete_id} removed`);
            }
            return;
        }

        const html = data.html;
        const postId = data.id;
        const author = data.author;
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = html.trim();
        const newPostElement = tempDiv.firstChild;
        const existingPost = document.getElementById(`post-${postId}`);

        if (existingPost) {
            existingPost.replaceWith(newPostElement);
            console.log(`Post ${postId} updated`);
        } else {
            postContainer.insertAdjacentElement("afterbegin", newPostElement);
            console.log(`Post ${postId} added`);
        }

        // Inject edit/delete buttons if the current user is the author
        if (currentUsername === author) {
            const controlsDiv = document.createElement("div");
            controlsDiv.classList.add("mt-2");

            const editButton = document.createElement("a");
            editButton.href = `/${postId}/edit/`;
            editButton.className = "btn btn-sm btn-outline-primary me-2";
            editButton.textContent = "Edit";

            const deleteButton = document.createElement("a");
            deleteButton.href = `/${postId}/delete/`;
            deleteButton.className = "btn btn-sm btn-outline-danger";
            deleteButton.textContent = "Delete";

            controlsDiv.appendChild(editButton);
            controlsDiv.appendChild(deleteButton);

            const cardBody = document.getElementById(`post-${postId}`).querySelector(".card-body");
            cardBody.appendChild(controlsDiv);
        }
    };

    socket.onclose = function (e) {
        console.error("WebSocket closed unexpectedly");
    };
</script>
{% endblock %}


